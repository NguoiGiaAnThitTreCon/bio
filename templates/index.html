<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bio — Nguyễn Trọng (VIP Pro)</title>

  <!-- Icons & fonts -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;900&family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">

  <!-- Vanta + three (for background) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r121/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.net.min.js"></script>

  <style>
    :root{
      --bg:#05060a;
      --glass: rgba(255,255,255,0.03);
      --gold1:#ffd54a;
      --gold2:#ffb300;
      --accentA: #7c3aed;
      --accentB: #06b6d4;
      --purple-main: #9b5cff; /* base purple */
      --purple-deep: #5b1bd9;
      --purple-glow: rgba(155,92,255,0.18);
      --max-width: 980px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;}
    body{
      font-family:'Poppins',sans-serif;
      background:var(--bg);
      color:#fff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow:hidden;
    }

    /* Background canvas container */
    #vanta-bg { position:fixed; inset:0; z-index:0; }

    /* Subtle overlay for cinematic gradient */
    .overlay {
      position:fixed; inset:0; z-index:1; pointer-events:none;
      background: linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.55));
      mix-blend-mode: overlay;
    }

    /* wave-layer for 3D purple wave effects */
    .wave-layer {
      position:fixed; inset:0; z-index:9; pointer-events:none; overflow:visible;
      perspective: 1200px;
    }
    .wave {
      position:absolute; width:160px; height:160px; border-radius:50%;
      transform-origin:center;
      background: radial-gradient(circle at 40% 40%, rgba(155,92,255,0.85), rgba(91,27,217,0.35) 40%, rgba(91,27,217,0.12) 60%, transparent 70%);
      filter: blur(8px) saturate(1.2);
      mix-blend-mode: screen;
      pointer-events:none;
      will-change: transform, opacity;
      animation: waveExpand 1000ms cubic-bezier(.2,.9,.3,1) forwards;
      box-shadow: 0 30px 80px rgba(91,27,217,0.22), inset 0 -6px 30px rgba(255,255,255,0.04);
    }
    @keyframes waveExpand{
      0%{ transform: translate3d(-50%,-50%,0) scale(.28) rotateX(18deg); opacity:0.95; filter: blur(6px) saturate(1.4); }
      60%{ transform: translate3d(-50%,-50%,-140px) scale(1.6) rotateX(8deg); opacity:0.52; filter: blur(18px) saturate(1.2); }
      100%{ transform: translate3d(-50%,-50%,-360px) scale(3.6) rotateX(0deg); opacity:0; filter: blur(30px) saturate(1); }
    }

    /* Enter cinematic */
    .enter-screen{
      position:fixed; inset:0; z-index:12;
      display:flex; align-items:center; justify-content:center; flex-direction:column; gap:18px;
      background:linear-gradient(180deg, rgba(2,6,23,0.85), rgba(0,0,0,0.9));
      backdrop-filter: blur(6px);
    }
    .logo{
      font-family:'Montserrat',sans-serif;
      font-size:42px; font-weight:900;
      letter-spacing:2px;
      background:linear-gradient(90deg,var(--accentA),var(--accentB));
      -webkit-background-clip:text;color:transparent;
      text-shadow: 0 6px 30px rgba(0,0,0,0.6);
    }
    .enter-btn{
      padding:14px 36px; border-radius:999px; border:none; cursor:pointer;
      background:linear-gradient(90deg,var(--gold1),var(--gold2));
      color:#0f0f10; font-weight:800; font-size:16px;
      box-shadow:0 10px 40px rgba(255,181,0,0.12), 0 6px 18px rgba(0,0,0,0.6);
      transform-origin:center;
    }
    .enter-screen.exit { animation: enterExit 900ms ease forwards; }
    @keyframes enterExit {
      0% { opacity:1; transform: scale(1); }
      100% { opacity:0; transform: scale(1.12) translateY(-40px); pointer-events:none; }
    }

    /* Main container */
    .wrap {
      position:relative; z-index:2; min-height:100vh;
      display:flex; align-items:center; justify-content:center; padding:48px 20px;
    }
    .card {
      width:min(95%, var(--max-width));
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:20px; padding:28px;
      box-shadow: 0 30px 90px rgba(2,6,23,0.7);
      display:flex; gap:26px; align-items:center; backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.03);
    }
    /* Left column (avatar) */
    .left {
      width:320px; min-width:220px; display:flex; flex-direction:column; align-items:center; gap:18px;
      position:relative;
    }

    /* Nitro-like avatar wrapper */
    .avatar-wrap {
      position:relative; width:220px; height:220px; border-radius:999px;
      display:grid; place-items:center;
      transform-style:preserve-3d;
      transition: transform 200ms ease;
      cursor:pointer;
    }
    /* Animated gradient border ring (outer) */
    .avatar-ring {
      position:absolute; inset:-10px; border-radius:999px;
      background: conic-gradient(from 0deg, var(--accentA), var(--accentB), #8b5cf6, #06b6d4, var(--accentA));
      filter: blur(10px);
      opacity:0.9;
      z-index:0;
      animation: ringRotate 8s linear infinite;
      mask: radial-gradient(farthest-side, black 60%, transparent 100%);
      -webkit-mask: radial-gradient(farthest-side, black 60%, transparent 100%);
      pointer-events:none;
    }
    @keyframes ringRotate { to { transform: rotate(360deg); } }

    /* Inner neon halo */
    .avatar-halo {
      position:absolute; inset:6px; border-radius:999px; z-index:1;
      background: radial-gradient(circle at 30% 20%, rgba(124,58,237,0.28), rgba(6,182,212,0.12) 30%, transparent 60%);
      filter: blur(14px); pointer-events:none;
    }

    /* actual avatar */
    .avatar {
      width:200px; height:200px; border-radius:999px; overflow:hidden;
      border: 3px solid rgba(255,255,255,0.06);
      z-index:2; background:#111; transform: translateZ(40px);
      box-shadow: 0 20px 60px rgba(6,26,37,0.6), 0 0 30px rgba(124,58,237,0.06);
    }
    .avatar img { width:100%; height:100%; object-fit:cover; display:block; }

    /* Nitro badge (top-right) */
    .badge {
      position:absolute; right:-6px; top:-6px; z-index:6;
      background: linear-gradient(90deg,var(--accentA),var(--accentB));
      color:white; font-weight:800; font-size:12px;
      padding:6px 10px; border-radius:999px; box-shadow:0 8px 30px rgba(7,16,38,0.6);
      transform: translateZ(60px); border:1px solid rgba(255,255,255,0.06);
    }

    /* particle canvas inside left area (so particles only near avatar) */
    #avatar-canvas { position:absolute; inset: -30px; z-index:0; pointer-events:none; }

    /* Right column (info) */
    .right { flex:1; display:flex; flex-direction:column; gap:10px; padding:6px 12px; min-width:220px; }

    /* Username area - replaced with 3D purple effect */
    .username {
      font-family:'Montserrat',sans-serif; font-size:48px; font-weight:900;
      color:transparent;
      -webkit-text-stroke: 0px rgba(0,0,0,0.2);
      transform-style:preserve-3d;
      perspective:900px;
      display:inline-block;
    }

    /* container for letter spans */
    .username .letter {
      display:inline-block;
      font-weight:900;
      font-size:inherit;
      transform-style:preserve-3d;
      -webkit-transform-style:preserve-3d;
      will-change: transform, text-shadow, opacity;
      transition: transform 420ms cubic-bezier(.2,.9,.3,1), text-shadow 420ms ease;
      margin:0 1px;
      color:var(--purple-main);
      background: linear-gradient(180deg, var(--purple-main), var(--purple-deep));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow:
        0 1px 0 rgba(255,255,255,0.02),
        0 6px 18px rgba(91,27,217,0.24),
        0 18px 40px rgba(12,8,28,0.65);
      transform: translateZ(20px);
    }

    /* faux extrusion for depth using duplicated shadow layers via pseudo elements */
    .username .letter::before,
    .username .letter::after {
      content: attr(data-char);
      position:absolute;
      left:0; top:0;
      z-index:-1;
      -webkit-text-stroke: 0;
      color:transparent;
      -webkit-background-clip:text;
      background: linear-gradient(180deg, rgba(91,27,217,0.9), rgba(27,0,87,0.6));
      -webkit-text-fill-color: transparent;
      transform-origin:left top;
      pointer-events:none;
    }
    .username .letter::before {
      transform: translate3d(6px,8px,-6px) scale(1);
      filter: blur(6px) opacity(.28;
    }
    .username .letter::after {
      transform: translate3d(10px,14px,-14px) scale(1);
      filter: blur(12px) opacity(.12);
    }

    /* floating/flying animation for each letter (small random) */
    .username .letter.float {
      animation: floatLetter var(--float-dur, 4000ms) ease-in-out infinite;
    }
    @keyframes floatLetter {
      0%{ transform: translate3d(0px,0px,18px) rotateX(2deg) }
      50%{ transform: translate3d(0px,-8px,36px) rotateX(-2deg) }
      100%{ transform: translate3d(0px,0px,18px) rotateX(2deg) }
    }

    /* hover interaction: letters respond and spread slightly */
    .username.hovered .letter {
      transition: transform 240ms cubic-bezier(.2,.9,.3,1), text-shadow 240ms ease;
    }
    .username.hovered .letter:hover {
      transform: translateZ(60px) rotateX(-6deg) rotateY(6deg) scale(1.06);
      text-shadow:
        0 2px 0 rgba(255,255,255,0.03),
        0 14px 40px rgba(91,27,217,0.34),
        0 34px 80px rgba(12,8,28,0.75);
    }

    /* subtitle/bio text */
    .bio {
      font-size:18px; font-weight:600; color:rgba(255,255,255,0.92);
      line-height:1.5; min-height:54px;
    }

    /* equalizer */
    .eq {
      display:flex; gap:6px; margin-top:6px; align-items:end; height:64px;
    }
    .eq .bar {
      width:8px; background:linear-gradient(180deg,var(--accentB),var(--accentA)); border-radius:6px;
      transform-origin: bottom center;
      box-shadow: 0 6px 20px rgba(6,182,212,0.12);
    }

    /* socials */
    .socials { display:flex; gap:12px; margin-top:12px; flex-wrap:wrap; }
    .social {
      display:inline-flex; align-items:center; justify-content:center;
      width:56px; height:56px; border-radius:12px; text-decoration:none; color:white;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.03); transition: transform .18s ease, box-shadow .18s ease;
      box-shadow: 0 8px 30px rgba(6,26,37,0.6);
    }
    .social:hover { transform:translateY(-6px); box-shadow: 0 18px 50px rgba(6,26,37,0.8), 0 0 30px rgba(124,58,237,0.12); }

    /* small screens */
    @media(max-width:820px){
      .card { flex-direction:column; align-items:center; padding:22px; gap:18px; }
      .left { width:100%; display:flex; align-items:center; justify-content:center; }
      .right { width:100%; text-align:center; padding:0; }
      .username { font-size:36px; }
      .avatar-wrap { width:160px; height:160px; }
      .avatar { width:140px; height:140px; }
    }

    /* subtle floating */
    .float-anim { animation: floaty 6s ease-in-out infinite; }
    @keyframes floaty {
      0%{ transform: translateY(0px) }
      50%{ transform: translateY(-8px) }
      100%{ transform: translateY(0px) }
    }
  </style>
</head>
<body>

  <div id="vanta-bg"></div>
  <div class="overlay"></div>
  <div class="wave-layer" id="waveLayer" aria-hidden="true"></div>

  <div class="enter-screen" id="enterScreen">
    <div class="logo">NGUYỄN TRỌNG — VIP PRO</div>
    <div style="color:rgba(255,255,255,0.65); margin-top:6px">Quá đẳng cấp</div>
    <button class="enter-btn" id="enterBtn">ENTER</button>
  </div>

  <div class="wrap" id="mainWrap" style="display:none;">
    <div class="card float-anim" role="region" aria-label="Bio card">
      <div class="left">
        <canvas id="avatar-canvas" width="400" height="400"></canvas>

        <div class="avatar-ring"></div>
        <div class="avatar-halo"></div>

        <div class="avatar-wrap" id="avatarWrap" title="Avatar">
          <div class="badge">PREMIUM</div>
          <div class="avatar" id="avatar">
            <img src="static/avatar.png" alt="avatar">
          </div>
        </div>

        <!-- Equalizer visual (also responds to music) -->
        <div style="width:100%; display:flex; flex-direction:column; align-items:center; margin-top:8px;">
          <div style="font-size:12px; color:rgba(255,255,255,0.6);">Now playing</div>
          <div class="eq" id="eq">
            <!-- 12 bars -->
            <div class="bar" style="height:14%"></div>
            <div class="bar" style="height:22%"></div>
            <div class="bar" style="height:18%"></div>
            <div class="bar" style="height:10%"></div>
            <div class="bar" style="height:26%"></div>
            <div class="bar" style="height:12%"></div>
            <div class="bar" style="height:20%"></div>
            <div class="bar" style="height:16%"></div>
            <div class="bar" style="height:22%"></div>
            <div class="bar" style="height:11%"></div>
            <div class="bar" style="height:24%"></div>
            <div class="bar" style="height:18%"></div>
          </div>
        </div>
      </div>

      <div class="right">
        <!-- username will be programmatically populated with spans for letters -->
        <div class="username neon" id="username" data-shadow="NGUYỄN TRỌNG" aria-live="polite"></div>
        <div class="bio" id="bioText">Quá vip</div>

        <div class="socials" id="socials">
          <a class="social" href="https://www.facebook.com/NguyenTrong6565" target="_blank" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
          <a class="social" href="https://discord.gg/bpZqKr2EWQ" target="_blank" aria-label="Discord"><i class="fab fa-discord"></i></a>
          <!-- thêm icon khác nếu cần -->
        </div>

        <div style="margin-top:auto; color:rgba(255,255,255,0.45); font-size:13px;">
          Phiên bản VIP • Đã tối ưu cho mobile • vẫn lag thì chịu
        </div>
      </div>
    </div>
  </div>

  <!-- background audio -->
  <audio id="bgAudio" loop crossorigin="anonymous">
    <source src="static/music.mp3" type="audio/mpeg">
  </audio>

  <script>
    // VANTA.NET background (subtle)
    VANTA.NET({
      el: "#vanta-bg",
      mouseControls: true,
      touchControls: true,
      minHeight: 200.00,
      minWidth: 200.00,
      scale: 1.0,
      scaleMobile: 1.0,
      backgroundColor: 0x05060a,
      color: 0x7c3aed,
      maxDistance: 22.00,
      showDots: true
    });

    const enterBtn = document.getElementById('enterBtn');
    const enterScreen = document.getElementById('enterScreen');
    const mainWrap = document.getElementById('mainWrap');
    const bgAudio = document.getElementById('bgAudio');
    const usernameEl = document.getElementById('username');
    const waveLayer = document.getElementById('waveLayer');

    // bio content (customize text here)
    const bioString = "My bio Nguyen TRong. Liên hệ: discord/FB.";
    const bioText = document.getElementById('bioText');

    // Render 3D "Nguyễn Trọng" into spans (letters) with small random float animations.
    function render3DName(text){
      // clear
      usernameEl.innerHTML = '';
      const frag = document.createDocumentFragment();
      // split into array but preserve spaces as &nbsp;
      const arr = Array.from(text);
      arr.forEach((ch, idx) => {
        const span = document.createElement('span');
        span.className = 'letter';
        span.setAttribute('data-char', ch === ' ' ? '\u00A0' : ch);
        span.textContent = ch === ' ' ? '\u00A0' : ch;
        // randomize float duration slightly
        const dur = 3600 + Math.floor(Math.random()*2200);
        span.style.setProperty('--float-dur', dur+'ms');
        // give some letters float class (makes them gently bob in Z)
        if(ch.trim() !== '' && Math.random() > 0.18) span.classList.add('float');
        // small random initial translateZ / rotate for subtle "scattered 3D" baseline
        const tz = 16 + Math.floor(Math.random()*36); // 16..52
        const rx = -6 + Math.random()*12; // -6..6
        const ry = -6 + Math.random()*12;
        span.style.transform = `translateZ(${tz}px) rotateX(${rx}deg) rotateY(${ry}deg)`;
        frag.appendChild(span);
      });
      usernameEl.appendChild(frag);
    }

    // create expanding purple wave at client coords
    function spawnWave(clientX, clientY){
      const el = document.createElement('div');
      el.className = 'wave';
      // position relative to viewport
      el.style.left = clientX + 'px';
      el.style.top = clientY + 'px';
      waveLayer.appendChild(el);
      // remove after animation end
      el.addEventListener('animationend', ()=> el.remove());
    }

    // Pre-attach pointer interactions: mousemove (gentle wave), click (stronger), and first entrance (center wave)
    let lastWaveAt = 0;
    document.addEventListener('mousemove', e => {
      // throttle gentle waves
      const now = Date.now();
      if(now - lastWaveAt < 220) return;
      lastWaveAt = now;
      spawnWave(e.clientX, e.clientY);
      // on pointer move, gently lift username letters toward pointer
      applyPointer3DEffect(e.clientX, e.clientY);
    });

    document.addEventListener('click', e => {
      // spawn a larger wave on click
      const large = document.createElement('div');
      large.className = 'wave';
      large.style.width = '260px';
      large.style.height = '260px';
      large.style.left = e.clientX + 'px';
      large.style.top = e.clientY + 'px';
      large.style.animation = 'waveExpand 1100ms cubic-bezier(.2,.9,.3,1) forwards';
      large.style.filter = 'blur(6px) saturate(1.3)';
      waveLayer.appendChild(large);
      large.addEventListener('animationend', ()=> large.remove());
      // small burst to avatar if clicked near it
      spawnBurst(e.clientX, e.clientY);
    });

    // pointer-based 3D tilt effect on letters (subtle)
    function applyPointer3DEffect(cx, cy){
      const rect = usernameEl.getBoundingClientRect();
      if(rect.width === 0) return;
      const centerX = rect.left + rect.width/2;
      const centerY = rect.top + rect.height/2;
      const dx = (cx - centerX) / rect.width; // -0.5..0.5
      const dy = (cy - centerY) / rect.height;
      // tilt container slightly
      usernameEl.style.transform = `perspective(900px) rotateX(${(-dy*6).toFixed(2)}deg) rotateY(${(dx*8).toFixed(2)}deg)`;
      // also subtly adjust each letter based on distance
      const letters = usernameEl.querySelectorAll('.letter');
      letters.forEach((l, i) => {
        const offset = (i - letters.length/2) * 0.26;
        const tz = 18 + offset * 6 - dx*14;
        const rx = -4 + dy*8 + Math.sin(i*0.6)*2;
        const ry = dx*6 + Math.cos(i*0.4)*2;
        l.style.transform = `translateZ(${tz}px) rotateX(${rx.toFixed(2)}deg) rotateY(${ry.toFixed(2)}deg)`;
      });
    }

    // ensure when mouse leaves, letters settle back
    document.addEventListener('mouseleave', () => {
      usernameEl.style.transform = '';
      const letters = usernameEl.querySelectorAll('.letter');
      letters.forEach((l) => {
        // gently return to original transform (use transition)
        l.style.transform = l.style.transform.replace(/translateZ\([^)]+\)/,'translateZ(22px)');
      });
    });

    // expose setVipProfile to re-render name properly
    window.setVipProfile = function({name, bio, avatarPath}){
      if(name) {
        render3DName(name);
        document.getElementById('username').setAttribute('data-shadow', name);
      }
      if(bio) { document.getElementById('bioText').textContent = bio; }
      if(avatarPath) { document.querySelector('#avatar img').src = avatarPath; }
    };

    // initial rendering for default name
    render3DName('NGUYỄN TRỌNG');

    // initial wave on first enter (center)
    function initialEntranceWave(){
      const cx = window.innerWidth/2;
      const cy = window.innerHeight/2;
      // spawn a couple of overlapping waves for dramatic entrance
      spawnWave(cx, cy);
      setTimeout(()=> spawnWave(cx+120, cy-80), 160);
      setTimeout(()=> spawnWave(cx-160, cy+60), 320);
    }

    enterBtn.addEventListener('click', async () => {
      enterScreen.classList.add('exit');
      setTimeout(()=>{ enterScreen.style.display='none'; mainWrap.style.display='flex'; }, 800);

      // play entrance wave
      setTimeout(initialEntranceWave, 240);

      // autoplay audio (user gesture required)
      try {
        await bgAudio.play();
        fadeInAudio(bgAudio, 0.0, 0.9, 1800);
        initAudioReactive();
      } catch (e) {
        // autoplay blocked — user can click anywhere to enable
        console.log('Audio autoplay blocked', e);
      }

      // typewriter bio
      let i=0;
      function typeWriter(){ if(i < bioString.length){ bioText.textContent += bioString.charAt(i++); setTimeout(typeWriter, 26); } }
      setTimeout(typeWriter, 420);
    });

    // audio fade helper
    function fadeInAudio(audio, from, to, ms){
      audio.volume = from;
      const step = (to - from) / (ms/60);
      const it = setInterval(()=>{ audio.volume = Math.min(to, audio.volume + step); if(audio.volume >= to) clearInterval(it); }, 60);
    }

    /* ----------------------------
       Avatar nitro-like interaction
       ---------------------------- */
    const avatarWrap = document.getElementById('avatarWrap');
    const avatar = document.getElementById('avatar');

    avatarWrap.addEventListener('mousemove', (e) => {
      const rect = avatarWrap.getBoundingClientRect();
      const px = (e.clientX - rect.left) / rect.width;
      const py = (e.clientY - rect.top) / rect.height;
      const rx = (py - 0.5) * 12; // rotateX
      const ry = (px - 0.5) * -18; // rotateY
      avatarWrap.style.transform = `perspective(700px) rotateX(${rx}deg) rotateY(${ry}deg) scale(1.03)`;
      // subtle brightness change based on pointer
      avatar.style.filter = `brightness(${1 + Math.abs(px-0.5) * 0.12}) saturate(${1 + Math.abs(py-0.5) * 0.06})`;
    });
    avatarWrap.addEventListener('mouseleave', () => {
      avatarWrap.style.transform = 'perspective(700px) rotateX(0) rotateY(0) scale(1)';
      avatar.style.filter = 'brightness(1) saturate(1)';
    });

    // click to pulse / burst effect
    avatarWrap.addEventListener('click', (e) => {
      pulseAvatar();
      spawnBurst(e.clientX, e.clientY);
      // also spawn a wave
      spawnWave(e.clientX, e.clientY);
    });

    // small pulse animation
    function pulseAvatar(){
      avatar.style.transition = 'transform 220ms cubic-bezier(.2,.8,.2,1)';
      avatar.style.transform = 'scale(1.06)';
      setTimeout(()=> avatar.style.transform = 'scale(1)', 220);
    }

    /* ----------------------------
       Particle canvas near avatar
       ---------------------------- */
    const canvas = document.getElementById('avatar-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    const DPR = window.devicePixelRatio || 1;
    function resizeCanvas(){
      canvas.width = canvas.clientWidth * DPR;
      canvas.height = canvas.clientHeight * DPR;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    function spawnParticle(x, y){
      const angle = Math.random()*Math.PI*2;
      const speed = 0.6 + Math.random()*2.4;
      particles.push({
        x: x, y: y,
        vx: Math.cos(angle)*speed,
        vy: Math.sin(angle)*speed - 1.2,
        life: 60 + Math.random()*40,
        r: 1 + Math.random()*3,
        hue: 260 + Math.random()*60
      });
      if(particles.length>220) particles.splice(0, particles.length-220);
    }

    function spawnBurst(clientX, clientY){
      const rect = canvas.getBoundingClientRect();
      const x = (clientX - rect.left) * DPR;
      const y = (clientY - rect.top) * DPR;
      for(let i=0;i<34;i++) spawnParticle(x, y);
    }

    // continuous ambient particles near avatar center
    setInterval(()=>{
      const rect = canvas.getBoundingClientRect();
      const cx = rect.width*DPR/2; const cy = rect.height*DPR/2;
      if(Math.random() < 0.6) spawnParticle(cx + (Math.random()-0.5)*40*DPR, cy + (Math.random()-0.5)*40*DPR);
    }, 160);

    function updateParticles(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      for(let i=particles.length-1;i>=0;i--){
        const p = particles[i];
        p.x += p.vx * DPR;
        p.y += p.vy * DPR;
        p.vy += 0.06 * DPR; // gravity
        p.life--;
        ctx.beginPath();
        const g = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.r*6*DPR);
        g.addColorStop(0, `hsla(${p.hue},85%,65%,0.95)`);
        g.addColorStop(0.35, `hsla(${p.hue},85%,55%,0.45)`);
        g.addColorStop(1, `hsla(${p.hue},85%,45%,0)`);
        ctx.fillStyle = g;
        ctx.arc(p.x, p.y, p.r*DPR, 0, Math.PI*2);
        ctx.fill();
        if(p.life <= 0) particles.splice(i,1);
      }
      requestAnimationFrame(updateParticles);
    }
    requestAnimationFrame(updateParticles);

    /* ----------------------------
       Audio reactive equalizer (WebAudio API)
       ---------------------------- */
    let audioCtx, analyser, sourceNode;
    function initAudioReactive(){
      if(!window.AudioContext && !window.webkitAudioContext) return;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 256;
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);

      try {
        sourceNode = audioCtx.createMediaElementSource(bgAudio);
      } catch(e) {
        console.warn('Cannot create media source: ', e);
        return;
      }
      sourceNode.connect(analyser);
      analyser.connect(audioCtx.destination);

      const bars = document.querySelectorAll('.eq .bar');

      function renderFrame(){
        analyser.getByteFrequencyData(dataArray);
        const step = Math.floor(dataArray.length / bars.length);
        for(let i=0;i<bars.length;i++){
          const sum = dataArray[i*step] || 0;
          const h = Math.max(6, (sum / 255) * 100);
          bars[i].style.height = `${h}%`;
          bars[i].style.opacity = 0.6 + (h/200);
        }
        // also animate avatar ring brightness with bass
        const bass = dataArray[2] + dataArray[3] + dataArray[4];
        const scale = 1 + Math.min(0.18, bass/800);
        document.querySelector('.avatar-ring').style.transform = `scale(${scale})`;
        requestAnimationFrame(renderFrame);
      }
      renderFrame();
    }

    // allow user to enable audio if autoplay blocked
    document.body.addEventListener('click', async function oneTapEnable(){
      if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
      if(bgAudio.paused) {
        try{ await bgAudio.play(); fadeInAudio(bgAudio, 0, 0.9, 1200); }catch(e){}
      }
      document.body.removeEventListener('click', oneTapEnable);
    });

    /* ----------------------------
       Small accessibility & performance tweaks
       ---------------------------- */
    // Pause heavy visual effects on small or low-power devices
    function isLowPower(){
      // cheap heuristics
      const mq = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if(mq) return true;
      if(window.innerWidth < 420) return false; // still show but lighter
      return false;
    }

    // initial demo spawn burst to draw attention after load
    setTimeout(()=> spawnBurst(canvas.getBoundingClientRect().left + canvas.width/2, canvas.getBoundingClientRect().top + canvas.height/2), 1200);

    // make username respond to hover state for enhanced interaction
    usernameEl.addEventListener('mouseenter', ()=> usernameEl.classList.add('hovered'));
    usernameEl.addEventListener('mouseleave', ()=> usernameEl.classList.remove('hovered'));

    // Expose helper for external changes (keeps consistent behavior)
    // (already defined above but ensure it's available)
    window.setVipProfile = window.setVipProfile || function({name, bio, avatarPath}) {
      if(name) { render3DName(name); document.getElementById('username').setAttribute('data-shadow', name); }
      if(bio) { document.getElementById('bioText').textContent = bio; }
      if(avatarPath) { document.querySelector('#avatar img').src = avatarPath; }
    };

    // spawn a welcome wave shortly after page load
    window.addEventListener('load', ()=> {
      setTimeout(initialEntranceWave, 800);
    });

  </script>
</body>
</html>
